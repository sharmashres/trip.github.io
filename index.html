<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TRIP TRICKLER - The App (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* --- DARK THEME CORE COLORS --- */
        :root {
            --primary-color: #2563eb; /* Blue-600 (Vibrant Accent) */
            --secondary-color: #f97316; /* Orange-500 (Energetic Accent) */
            --background-dark: #111827; /* Gray-900 - Deepest Dark */
            --card-dark: #1f2937; /* Gray-800 - Card/Container Dark */
            --text-light: #f3f4f6; /* Gray-100 - Primary Text */
            --text-muted: #9ca3af; /* Gray-400 - Muted Text */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Applied Dark Background */
            color: var(--text-light); /* Applied Light Text */
        }
        
        /* General Text & Input Adjustments for Dark Mode */
        .text-gray-800 { color: var(--text-light); }
        .text-gray-700 { color: var(--text-light); }
        .text-gray-600 { color: var(--text-muted); }
        .text-gray-500 { color: var(--text-muted); }
        .bg-white { background-color: var(--card-dark); }
        .bg-gray-50 { background-color: var(--background-dark); }
        .bg-gray-100 { background-color: #374151; } /* Darker gray for accents */
        .border-gray-200 { border-color: #374151; }
        .border-gray-300 { border-color: #4b5563; }

        /* --- BACKGROUND IMAGES FOR MAIN PAGES (IMPROVEMENT) --- */
        .page-content-wrapper {
            position: relative;
            z-index: 1; /* Ensure content is above background */
        }

        #page-dashboard {
             background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #page-planner {
             background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-position: center;
        }
        #page-buddies {
             background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #page-explore {
             background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        /* Ensure Chat, Profile, and Auth maintain specific backgrounds */
        #page-messages, #page-profile {
            background-image: none;
            background-color: var(--background-dark);
        }


        /* AUTH PAGE ENHANCEMENT (Dark Overlay) */
        .auth-bg {
            /* Darker overlay for better white text visibility */
             background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        /* Auth Card adjustment */
        #page-auth .bg-white\\/95 { 
            background-color: rgba(31, 41, 55, 0.95); /* Semi-transparent dark card */
            backdrop-filter: blur(5px);
        }
        #page-auth input {
            background-color: #1f2937;
            color: var(--text-light);
        }

        .page { display: none; }
        .page.active { display: block; }
        
        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(255, 255, 255, .1); /* Light border contrast */
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .modal { transition: opacity 0.25s ease; }

        /* Explore Nearby Styles (Invert Colors) */
        .place-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .place-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.5), 0 5px 10px -5px rgba(0, 0, 0, 0.4);
        }
        .category-filter {
            background-color: var(--card-dark);
            border-color: #5b6e89;
            color: var(--text-light);
        }
        .category-filter.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .rating-stars { color: #fbbf24; }
        #review-stars i:hover, #review-stars i.active { color: #fbbf24; }
        #map { height: 300px; border-radius: 12px; z-index: 10; }
        .leaflet-popup-content { margin: 13px 19px; font-family: 'Inter', sans-serif; color: #111827; } /* Keep popup content readable */

        /* Planner Styles (Dark Text/Backgrounds) */
        .interest-btn {
            background-color: #e8eaee !important;
            color: grey !important;
            border: 2px solid transparent;
        }
        .interest-btn.active {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }
        
        /* Itinerary Timeline Styles (Dark Base) */
                  .itinerary-content h3 { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 1.5rem; color: #1f2937; }
            .itinerary-content h4 { font-size: 1.25rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1.5rem; color: #374151; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
            .itinerary-content ul { list-style: none; padding: 0; }
            .timeline-item { position: relative; padding: 0 0 2.5rem 2.5rem; border-left: 2px solid #d1d5db; }
            .timeline-item:last-child { border-left: 2px solid transparent; }
            .timeline-icon { position: absolute; left: -0.8rem; top: 0.25rem; background: white; border-radius: 9999px; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color); }
            .timeline-icon i { color: var(--primary-color); font-size: 0.8rem; }
            .timeline-time { font-weight: 600; color: #4b5563; margin-bottom: 0.25rem; }
            .timeline-desc { color: #6b7280; }
            .travel-style-tag {
                cursor: pointer;
                transition: all 0.2s ease;
            }
            .travel-style-tag.selected {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);}

        /* Navigation and Buttons */
        #bottom-nav { background-color: var(--card-dark); border-top: 1px solid #374151; }
        .bottom-nav-item { color: var(--text-muted); }
        .bottom-nav-item.active { color: var(--primary-color); }
        
        /* Chat Window Dark Mode */
        #page-messages header { background-color: var(--card-dark); border-color: #374151; }
        #chat-container { background-color: var(--background-dark); }
        #conversations-list { border-color: #374151; }
        .conversation-item { border-color: #374151; }
        .conversation-item:hover { background-color: #1f2937; }
        .conversation-item.active { background-color: #1f2937; }
        
        #chat-messages { background-color: var(--background-dark); }
        /* Sender is You: White text on Primary Blue background */
        .flex.justify-end > div {
            background-color: var(--primary-color);
            color: white;
        }
        /* Sender is Buddy: Light text on Dark Card background */
        .flex.justify-start > div {
            background-color: var(--card-dark);
            color: var(--text-light);
        }
        #message-form input { 
            background-color: #374151; 
            border-color: #4b5563;
            color: var(--text-light);
        }

        /* Modals and forms */
        .modal > div:not(.modal) { background-color: var(--card-dark); }
        #expense-form input { background-color: #374151; color: var(--text-light); border-color: #4b5563; }
        .bg-gray-200 { background-color: #4b5563; color: white !important; }
        .hover\\:bg-gray-300:hover { background-color: #6b7280; }
        .bg-gray-50 { background-color: var(--background-dark); } /* Profile page container */
        .divide-y.divide-gray-200 > li { border-color: #374151; }

    </style>
</head>
<body class="overscroll-none">

    <div id="notification" class="notification fixed top-5 right-5 p-4 rounded-lg text-white z-50 transform translate-x-full transition-transform duration-300"></div>

    <main id="page-auth" class="page active">
        <div class="min-h-screen flex items-center justify-center auth-bg p-4">
            <div class="w-full max-w-md bg-white/95 backdrop-blur-sm rounded-2xl shadow-main p-10">
                <div class="flex items-center justify-center space-x-2 mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[--primary-color]"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    <h1 class="text-3xl font-extrabold text-gray-800">TRIP TRICKLER</h1>
                </div>
                
                <div id="login-form-container">
                    <h2 class="text-center text-2xl font-bold text-gray-800 mb-2">Welcome Back!</h2>
                    <p class="text-center text-gray-600 mb-8">Login to plan your next adventure.</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" value="alex@example.com" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" value="password" required>
                        </div>
                        <button type="submit" class="w-full bg-[--primary-color] text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-[#1d4ed8] transition-all text-lg">
                            Login
                        </button>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Don't have an account? <a href="#" id="show-signup-link" class="font-semibold text-[--primary-color] hover:underline">Sign Up</a>
                        </p>
                    </form>
                </div>

                <div id="signup-form-container" class="hidden">
                    <h2 class="text-center text-2xl font-bold text-gray-800 mb-2">Create Account</h2>
                    <p class="text-center text-gray-600 mb-8">Join our community of travelers.</p>
                    <form id="signup-form">
                        <div class="mb-4">
                            <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="signup-name" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" placeholder="e.g., Alex Doe" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="signup-email" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" placeholder="alex@example.com" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="signup-password" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" required>
                        </div>
                        <button type="submit" class="w-full bg-[--primary-color] text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-[#1d4ed8] transition-all text-lg">
                            Create Account
                        </button>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Already have an account? <a href="#" id="show-login-link" class="font-semibold text-[--primary-color] hover:underline">Login</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="main-app-content" class="hidden">
        <div id="app-container" class="pb-20"> 
            
            <main id="page-dashboard" class="page">
                <div class="p-6 page-content-wrapper">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <p class="text-white">Welcome back,</p>
                            <h2 id="welcome-message" class="text-3xl font-extrabold text-white">Alex!</h2>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="dashboard-messages-btn" class="text-white hover:text-[--primary-color] text-2xl transition-colors"><i class="fas fa-comments"></i></button>
                            <div class="w-12 h-12 bg-[--primary-color] rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg" id="dashboard-avatar">A</div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h3 class="text-xl font-bold text-white mb-4">My Upcoming Trips</h3>
                        <div id="my-trips-grid" class="flex overflow-x-auto space-x-4 horizontal-scroll pb-4">
                            <div class="flex-shrink-0 w-64 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-center p-6 bg-white hover:bg-gray-50 transition-colors duration-300 cursor-pointer shadow-sm" onclick="document.getElementById('nav-planner').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-[--primary-color] mb-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <h3 class="font-semibold text-gray-700">Plan a New Trip</h3>
                            </div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h3 class="text-xl font-bold text-white mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div id="dashboard-plan-card" class="cursor-pointer bg-white p-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02]">
                                <div class="bg-blue-100 rounded-xl p-3 inline-block mb-2"><i class="fas fa-magic-wand-sparkles text-[--primary-color] text-2xl"></i></div>
                                <p class="text-sm font-medium text-gray-700">AI Planner</p>
                            </div>
                            <div id="dashboard-buddy-card" class="cursor-pointer bg-white p-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02]">
                                <div class="bg-orange-100 rounded-xl p-3 inline-block mb-2"><i class="fas fa-users text-[--secondary-color] text-2xl"></i></div>
                                <p class="text-sm font-medium text-gray-700">Find a Buddy</p>
                            </div>
                            <div id="dashboard-explore-card" class="cursor-pointer bg-white p-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02]">
                                <div class="bg-red-100 rounded-xl p-3 inline-block mb-2"><i class="fas fa-map-marked-alt text-red-600 text-2xl"></i></div>
                                <p class="text-sm font-medium text-gray-700">Explore</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-10">
                        <h3 class="text-xl font-bold text-white mb-4">Join an Adventure</h3>
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 border-l-4 border-[--secondary-color]">
                                <img src="https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=400&auto=format&fit=crop" class="w-20 h-20 rounded-lg object-cover shadow-sm">
                                <div>
                                    <h4 class="font-bold text-white">Japan Discovery</h4>
                                    <p class="text-sm text-gray-500">Dec 1 - Dec 15</p>
                                    <div class="flex items-center text-teal-600 mt-1"><i class="fas fa-users mr-2"></i>2/4 spots filled</div>
                                </div>
                                <button class="ml-auto bg-[--secondary-color] text-white font-semibold px-4 py-2 rounded-lg text-sm hover:bg-orange-600 transition-colors">Join</button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4">Recommended for You</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative rounded-xl overflow-hidden h-40 shadow-lg transition-transform hover:scale-[1.02] cursor-pointer">
                                <img src="https://images.unsplash.com/photo-1552832230-c0197cefa10c?q=80&w=400&auto=format&fit=crop" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40"></div>
                                <p class="absolute bottom-3 left-3 text-white font-extrabold text-lg">Venice</p>
                            </div>
                            <div class="relative rounded-xl overflow-hidden h-40 shadow-lg transition-transform hover:scale-[1.02] cursor-pointer">
                                <img src="https://images.unsplash.com/photo-1543884803-164741f0219c?q=80&w=400&auto=format&fit=crop" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40"></div>
                                <p class="absolute bottom-3 left-3 text-white font-extrabold text-lg">Patagonia</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <main id="page-planner" class="page">
                <div class="p-6 page-content-wrapper">
                    <h2 class="text-3xl font-extrabold text-white text-center mb-2">AI Itinerary Planner</h2>
                    <p class="text-center text-white max-w-2xl mx-auto mb-8">Tell us your travel style and we'll craft the perfect plan.</p>
                    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-main">
                        <form id="planner-form" class="p-8">
                            <div class="space-y-6">
                                <div>
                                    <label for="destination" class="block text-base font-semibold text-gray-700 mb-2">Destination</label>
                                    <input type="text" id="destination" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" placeholder="e.g., Kyoto, Japan" required>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="duration" class="block text-base font-semibold text-gray-700 mb-2">Duration (days)</label>
                                        <input type="number" id="duration" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" placeholder="e.g., 5" required value="5">
                                    </div>
                                    <div>
                                        <label for="travel-date" class="block text-base font-semibold text-gray-700 mb-2">Starting Date (Optional)</label>
                                        <input type="date" id="travel-date" class="w-full p-3 border border-gray-300 rounded-xl focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]">
                                    </div>
                                </div>
                            </div>
                            <div class="my-8">
                                <label class="block text-base font-semibold text-gray-700 mb-2">Budget Preference</label>
                                <div class="flex justify-between text-sm text-gray-500 mb-2 font-medium"><span>Budget</span><span>Moderate</span><span>Luxury</span></div>
                                <input type="range" id="budget" min="1" max="3" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>
                            <div class="my-8">
                                <label class="block text-base font-semibold text-gray-700 mb-3">Interests (Select all that apply)</label>
                                <div id="interests-container" class="flex flex-wrap gap-3">
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="History & Culture">History & Culture</button>
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="Food & Drink">Food & Drink</button>
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="Adventure & Outdoors">Adventure & Outdoors</button>
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="Relaxation">Relaxation</button>
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="Nightlife">Nightlife</button>
                                    <button type="button" class="interest-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200" data-interest="Architecture">Architecture</button>
                                </div>
                            </div>
                            <button type="submit" id="generate-itinerary-btn" class="w-full bg-[--primary-color] text-white font-bold py-3 px-6 rounded-xl hover:bg-[#1d4ed8] transition-all text-lg shadow-md">
                                <i class="fas fa-magic-wand-sparkles mr-2"></i> Generate My Itinerary
                            </button>
                        </form>

                        <div id="planner-loading" class="hidden text-center p-12">
                            <div class="spinner mx-auto mb-4"></div>
                            <p class="text-gray-600 font-medium text-lg">Crafting your perfect trip, tailored to your style...</p>
                        </div>
                        
                        <div id="planner-results" class="hidden">
                            <div id="itinerary-header" class="relative h-48 bg-gray-500 bg-cover bg-center rounded-t-2xl flex items-center justify-center">
                                <div class="absolute inset-0 bg-black/50 rounded-t-2xl"></div>
                                <div class="relative text-white text-center p-4">
                                    <h3 class="text-3xl font-extrabold" id="itinerary-title"></h3>
                                    <p class="text-lg font-medium" id="itinerary-dates"></p>
                                </div>
                            </div>
                            <div id="itinerary-content" class="p-8 itinerary-content"></div>
                            <div class="p-6 border-t border-gray-100 flex justify-center gap-4 bg-gray-50 rounded-b-2xl">
                                <button id="save-itinerary-btn" class="bg-[--primary-color] text-white font-bold py-3 px-6 rounded-xl hover:bg-[#1d4ed8] transition-colors shadow-md">
                                    <i class="fas fa-save mr-2"></i> Save Itinerary
                                </button>
                                <button id="regenerate-itinerary-btn" class="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl hover:bg-[#1d4ed8] transition-colors">
                                    <i class="fas fa-rotate-left mr-2"></i> Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <main id="page-buddies" class="page">
                <div class="p-6 page-content-wrapper">
                    <h2 class="text-3xl font-extrabold text-white text-center mb-2">Find Your Travel Buddy</h2>
                    <p class="text-center text-white max-w-2xl mx-auto mb-8">Connect with other travelers with similar plans and interests.</p>
                    <div class="sticky top-0 bg-gray-100 py-4 z-10 -mx-6 px-6 border-b border-gray-200">
                        <div class="flex bg-white p-3 rounded-xl shadow-md gap-3">
                            <i class="fas fa-search text-gray-400 self-center ml-1"></i>
                            <input type="text" id="buddy-dest" placeholder="Search by destination (e.g., Paris)..." class="w-full p-2 bg-transparent focus:outline-none">
                            <select id="buddy-interest" class="p-2 border-l border-gray-200 bg-transparent focus:outline-none text-gray-600 text-sm rounded-lg">
                                <option value="any">Any Interest</option><option value="foodie">Foodie</option><option value="art">Art Lover</option><option value="adventure">Adventure</option><option value="beach">Beach</option><option value="relaxation">Relaxation</option>
                            </select>
                        </div>
                    </div>
                    <div id="buddies-grid" class="mt-6 space-y-4">
                    </div>
                </div>
            </main>

            <main id="page-explore" class="page">
                <div class="p-6 page-content-wrapper">
                    <h2 class="text-3xl font-extrabold text-white text-center mb-2">Explore Nearby</h2>
                    <p class="text-center text-white max-w-2xl mx-auto mb-8">Discover hidden gems around you.</p>
                    <button onclick="getLocation()" class="w-full bg-[--secondary-color] text-white px-8 py-3 rounded-xl font-semibold text-lg hover:bg-orange-600 transition-colors mb-6 shadow-md">
                        <i class="fas fa-location-arrow mr-2"></i>Find Places Near Me
                    </button>
                    <div id="map" class="w-full mb-6 shadow-lg"></div>
                    <div class="flex flex-nowrap overflow-x-auto gap-3 pb-4 mb-4 horizontal-scroll">
                        <button class="category-filter active flex-shrink-0 px-4 py-2 rounded-full border bg-white text-gray-700" data-category="all"><i class="fas fa-star mr-2"></i>All</button>
                        <button class="category-filter flex-shrink-0 px-4 py-2 rounded-full border bg-white text-gray-700" data-category="cafe"><i class="fas fa-coffee mr-2"></i>Cafés</button>
                        <button class="category-filter flex-shrink-0 px-4 py-2 rounded-full border bg-white text-gray-700" data-category="historical"><i class="fas fa-landmark mr-2"></i>Historical</button>
                        <button class="category-filter flex-shrink-0 px-4 py-2 rounded-full border bg-white text-gray-700" data-category="park"><i class="fas fa-tree mr-2"></i>Parks</button>
                        <button class="category-filter flex-shrink-0 px-4 py-2 rounded-full border bg-white text-gray-700" data-category="nightlife"><i class="fas fa-moon mr-2"></i>Nightlife</button>
                    </div>
                    <div id="places-grid" class="space-y-4"></div>
                </div>
            </main>
            
            <main id="page-messages" class="page">
                <header class="p-4 bg-white border-b sticky top-0 z-20 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 text-center">Messages</h2>
                </header>
                <div id="chat-container" class="bg-white flex">
                    <div id="conversations-list" class="w-full md:w-1/3 border-r border-gray-200 overflow-y-auto"></div>
                    <div id="chat-window" class="w-full md:w-2/3 flex-col hidden md:flex"></div>
                </div>
            </main>

            <main id="page-profile" class="page bg-gray-50">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-extrabold text-gray-800">My Profile</h2>
                        <button id="logout-link" class="text-red-500 font-semibold hover:text-red-600 transition-colors">Logout</button>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <div class="relative w-28 h-28 mx-auto mb-4">
                        <img id="profile-picture" src="https://placehold.co/160x160/2563eb/ffffff?text=A" alt="Alex Doe" class="w-28 h-28 rounded-full border-4 border-white shadow-md object-cover">
                        <label for="profile-pic-upload" class="absolute bottom-0 right-0 bg-[--primary-color] w-8 h-8 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-[#1d4ed8] transition-colors"><i class="fas fa-camera text-sm"></i></label>
                        <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                        </div>
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-800">Alex Doe</h2>
                        <p class="text-gray-500 mb-4 text-sm">Joined in 2025</p>
                        <p id="profile-bio-text" class="text-gray-600 leading-relaxed mb-6 italic max-w-md mx-auto"></p>
                        <div id="profile-travel-styles" class="flex flex-wrap gap-2 justify-center mb-6"></div>
                        <button id="edit-profile-btn" class="w-full bg-blue-100 text-[--primary-color] font-semibold px-5 py-3 rounded-xl hover:bg-blue-200 transition-colors">Edit Profile</button>
                    </div>
                    
                    <div class="mt-8 bg-white rounded-2xl shadow-lg overflow-hidden">
                        <ul class="divide-y divide-gray-200">
                            <li><a href="#" id="about-us-link" class="flex items-center p-4 hover:bg-gray-50 transition-colors"><i class="fas fa-info-circle w-6 text-center text-[--primary-color] mr-4"></i><span>About Us</span><i class="fas fa-chevron-right ml-auto text-gray-400 text-sm"></i></a></li>
                            <li><a href="#" id="contact-support-link" class="flex items-center p-4 hover:bg-gray-50 transition-colors"><i class="fas fa-envelope w-6 text-center text-[--primary-color] mr-4"></i><span>Contact & Support</span><i class="fas fa-chevron-right ml-auto text-gray-400 text-sm"></i></a></li>
                            <li><a href="#" id="help-center-link" class="flex items-center p-4 hover:bg-gray-50 transition-colors"><i class="fas fa-question-circle w-6 text-center text-[--primary-color] mr-4"></i><span>Help Center</span><i class="fas fa-chevron-right ml-auto text-gray-400 text-sm"></i></a></li>
                        </ul>
                    </div>

                    <div id="reviews-section" class="mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">My Reviews</h3>
                        <div id="reviews-list" class="space-y-4">
                            </div>
                    </div>
                </div>
            </main>
        </div>

        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around h-16 z-30 shadow-2xl">
            <a href="#" id="nav-dashboard" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-gray-500 hover:text-[--primary-color] transition-colors">
                <i class="fas fa-home text-xl"></i><span class="text-xs mt-1 font-medium">Home</span>
            </a>
            <a href="#" id="nav-explore" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-gray-500 hover:text-[--primary-color] transition-colors">
                <i class="fas fa-map-marked-alt text-xl"></i><span class="text-xs mt-1 font-medium">Explore</span>
            </a>
            <a href="#" id="nav-planner" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-gray-500 hover:text-[--primary-color] -mt-4 transition-colors">
                <div class="w-16 h-16 bg-[--primary-color] rounded-full text-white flex items-center justify-center shadow-main hover:bg-[#1d4ed8] transition-colors"><i class="fas fa-plus text-2xl"></i></div>
            </a>
            <a href="#" id="nav-buddies" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-gray-500 hover:text-[--primary-color] transition-colors">
                <i class="fas fa-users text-xl"></i><span class="text-xs mt-1 font-medium">Buddies</span>
            </a>
            <a href="#" id="nav-profile" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-gray-500 hover:text-[--primary-color] transition-colors">
                <i class="fas fa-user-circle text-xl"></i><span class="text-xs mt-1 font-medium">Profile</span>
            </a>
        </nav>
    </div>
    
    <div id="request-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-sm w-full text-center transform transition-transform duration-300 scale-95 opacity-0" id="request-modal-content">
            <i class="fas fa-user-plus text-5xl text-[--secondary-color] mb-4"></i>
            <h3 class="text-2xl font-bold mb-4">Send Buddy Request?</h3>
            <p class="text-gray-600 mb-6">A connection request will be sent to **<span id="buddy-request-name" class="font-semibold text-gray-800"></span>**. Connect and plan a trip!</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-request-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 font-medium">Cancel</button>
                <button id="confirm-request-btn" class="px-6 py-2 bg-[--secondary-color] text-white rounded-xl hover:bg-orange-600 font-medium shadow-md">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="edit-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 opacity-0" id="edit-profile-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Edit Profile</h3>
                <button id="close-profile-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="profile-edit-form">
                <div class="mb-4">
                    <label for="modal-profile-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="modal-profile-name" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]">
                </div>
                <div class="mb-4">
                    <label for="modal-profile-bio" class="block text-sm font-medium text-gray-700 mb-1">About Me</label>
                    <textarea id="modal-profile-bio" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">My Travel Style</label>
                    <div id="modal-travel-styles" class="flex flex-wrap gap-3">
                        </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-profile-edit-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 font-medium">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-[--primary-color] text-white rounded-xl hover:bg-[#1d4ed8] font-medium">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="review-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-md w-full transform transition-transform duration-300 scale-95 opacity-0" id="review-modal-content">
            <i class="fas fa-star-half-stroke text-5xl text-yellow-500 mb-4 mx-auto block"></i>
            <h3 class="text-whiteont-bold mb-4 text-center">Review Your Trip</h3>
            <p class="text-center text-white mb-6">How was your trip to <span id="review-destination" class="font-semibold text-gray-800"></span>?</p>
            <form id="review-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-whiteb-2 text-center">Your Rating</label>
                    <div id="review-stars" class="flex justify-center text-3xl text-gray-300 cursor-pointer space-x-1">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="review-rating-value" required>
                </div>
                <div class="mb-6">
                    <label for="review-text" class="block text-sm font-medium text-black mb-1">Your Review</label>
                    <textarea id="review-text" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[--primary-color] focus:ring-1 focus:ring-[--primary-color]" placeholder="Share your experience..." required></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-review-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 font-medium">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-[--primary-color] text-white rounded-xl hover:bg-[#1d4ed8] font-medium">Submit Review</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="about-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold text-black">About Trip Trickler</h3><button class="close-info-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
            <p class="text-white mb-4">Trip Trickler was born from a simple idea: travel is better when it's simple, social, and smart. We connect travelers with companions and provide AI-generated itineraries to make every journey unforgettable.</p>
            <p class="text-white">Our mission is to take the stress out of planning and help you discover the world's hidden gems with the right people by your side.</p>
        </div>
    </div>
    <div id="contact-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold text-white">Contact & Support</h3><button class="close-info-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
            <div class="space-y-4 text-white">
                <p><i class="fas fa-envelope mr-3 text-white w-5"></i> support@triptrickler.com</p>
                <p><i class="fas fa-phone mr-3 text-white w-5"></i> +1 (555) 123-4567</p>
                <div class="flex space-x-4 pt-2">
                    <i class="fab fa-twitter text-[--primary-color] text-2xl cursor-pointer hover:text-[#1d4ed8]"></i>
                    <i class="fab fa-instagram text-[--primary-color] text-2xl cursor-pointer hover:text-[#1d4ed8]"></i>
                    <i class="fab fa-facebook text-[--primary-color] text-2xl cursor-pointer hover:text-[#1d4ed8]"></i>
                </div>
            </div>
        </div>
    </div>
    <div id="help-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold text-black">Help Center</h3><button class="close-info-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
            <div class="space-y-4">
                <div><h4 class="font-semibold text-white">How does the AI Planner work?</h4><p class="text-white text-sm">Just enter your destination, duration, and interests, and our AI will create a custom day-by-day plan for you!</p></div>
                <div><h4 class="font-semibold text-white">Is finding a travel buddy safe?</h4><p class="text-white text-sm">We encourage users to chat and get to know each other before traveling. Always prioritize safety and meet in public places.</p></div>
            </div>
        </div>
    </div>
    
    <div id="view-trip-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-main max-w-lg w-full h-[90vh] flex flex-col transform transition-transform duration-300 scale-95 opacity-0">
            <div id="view-trip-header" class="relative h-48 bg-gray-500 bg-cover bg-center flex-shrink-0 rounded-t-xl">
                <div class="absolute inset-0 bg-black/50 rounded-t-xl"></div>
                <h3 id="view-trip-title" class="absolute bottom-4 left-4 text-white text-3xl font-bold"></h3>
                <button id="close-view-trip-btn" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-200 transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="itinerary-content" id="view-trip-itinerary"></div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Budget Tracker</h3>
                    <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                        <div class="flex justify-between font-semibold mb-2 text-sm">
                            <span>Spent: <span id="budget-spent" class="text-red-600">₹0</span></span>
                            <span>Budget: <span id="budget-total" class="text-green-600">₹5000</span></span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-2.5">
                            <div id="budget-progress" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <form id="expense-form" class="mt-4 flex gap-2">
                            <input type="text" id="expense-desc" placeholder="Expense description" class="w-2/3 p-2 border border-gray-300 rounded-lg text-sm" required>
                            <input type="number" id="expense-amount" placeholder="Amount" class="w-1/3 p-2 border border-gray-300 rounded-lg text-sm" required>
                            <button type="submit" class="bg-[--primary-color] text-white px-3 rounded-lg hover:bg-[#1d4ed8] transition-colors"><i class="fas fa-plus"></i></button>
                        </form>
                        <ul id="expense-list" class="mt-4 space-y-2 divide-y divide-gray-200"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            notification.classList.add('fixed', 'top-5', 'right-5', 'p-4', 'rounded-lg', 'text-white', 'z-50', 'transition-transform', 'duration-300');
            notification.classList.remove('translate-x-full');
            if (type === 'success') { notification.classList.add('bg-teal-600'); notification.classList.remove('bg-red-600'); }
            else if (type === 'error') { notification.classList.add('bg-red-600'); notification.classList.remove('bg-teal-600'); }

            setTimeout(() => { notification.classList.add('translate-x-full'); }, 3000);
        }

        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            
            for (let i = 0; i < fullStars; i++) { stars += '<i class="fas fa-star"></i>'; }
            if (hasHalfStar) { stars += '<i class="fas fa-star-half-alt"></i>'; }
            for (let i = 0; i < 5 - Math.ceil(rating); i++) { stars += '<i class="far fa-star"></i>'; }
            
            return `<span class="text-yellow-400 text-xs">${stars}</span>`;
        }

        function openInfoModal(modal) {
            const modalContent = modal.querySelector('div:not(.modal)');
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); // Prevent background scroll
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeInfoModal(modal) {
            const modalContent = modal.querySelector('div:not(.modal)');
            modal.classList.add('opacity-0');
            modalContent.classList.add('opacity-0', 'scale-95');
            modalContent.classList.remove('scale-100');
            document.body.classList.remove('overflow-hidden'); // Restore background scroll
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        // --- START OF ITINERARY FIX/ENHANCEMENT ---
        function generateMockItineraryHTML(destination, duration, interests, travelDate) {
            const numDays = parseInt(duration);
            const selectedInterests = interests.length > 0 ? interests.join(', ') : 'Mixed activities';
            
            let itinerary = `
                <h3 class="text-2xl font-extrabold text-[--primary-color] text-center mb-6">Your ${numDays} Day Trip to ${destination}</h3>
                <p class="text-center text-gray-600 italic mb-8">Focus: ${selectedInterests}</p>
            `;
            const startDate = travelDate ? new Date(travelDate) : new Date();

            for (let day = 1; day <= numDays; day++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + day - 1);
                const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                
                itinerary += `
                    <h4>Day ${day}: ${dateString} - Adventure Day!</h4>
                    <ul>
                        <li class="timeline-item">
                            <div class="timeline-icon"><i class="fas fa-sun"></i></div>
                            <p class="timeline-time">Morning (8:00 AM)</p>
                            <p class="timeline-desc">Start your day with a local market visit and grab a light breakfast, perfect for the ${interests[0] || 'Foodie'} interest.</p>
                        </li>
                        <li class="timeline-item">
                            <div class="timeline-icon"><i class="fas fa-route"></i></div>
                            <p class="timeline-time">Mid-day (10:00 AM)</p>
                            <p class="timeline-desc">${interests.includes('History & Culture') ? 'Explore the main historical site (e.g., a museum or ancient temple) in the city center.' : 'Head to a scenic park or nature trail for a refreshing outdoor walk.'}</p>
                        </li>
                        <li class="timeline-item">
                            <div class="timeline-icon"><i class="fas fa-utensils"></i></div>
                            <p class="timeline-time">Lunch (1:00 PM)</p>
                            <p class="timeline-desc">Try a highly-rated local restaurant or food stall for authentic ${destination} cuisine.</p>
                        </li>
                        <li class="timeline-item">
                            <div class="timeline-icon"><i class="fas fa-camera"></i></div>
                            <p class="timeline-time">Afternoon (3:00 PM)</p>
                            <p class="timeline-desc">${interests.includes('Relaxation') ? 'Find a quiet cafe or spa for some relaxation and downtime.' : 'Discover a lesser-known neighborhood for photography and unique shops.'}</p>
                        </li>
                        <li class="timeline-item">
                            <div class="timeline-icon"><i class="fas fa-glass-martini-alt"></i></div>
                            <p class="timeline-time">Evening (7:00 PM)</p>
                            <p class="timeline-desc">${interests.includes('Nightlife') ? 'Hit a trendy rooftop bar or club in the nightlife district.' : 'A quiet dinner at your favorite spot, preparing for the next day.'}</p>
                        </li>
                    </ul>
                `;
            }

            return itinerary;
        }
        // --- END OF ITINERARY FIX/ENHANCEMENT ---


        // Dummy data for Explore Nearby
        const places = [
            { id: 1, name: "Lodhi Garden (Hidden Corners)", category: "park", rating: 4.8, reviews: 124, distance: "0.8km", image: "https://images.unsplash.com/photo-1596765793467-33e5c9b68e91?q=80&w=400&auto=format&fit=crop", alt: "Quiet greenery with ancient monuments", description: "Quiet greenery, perfect for a morning walk or evening hangout.", hours: "Open 6 AM - 8 PM", safety: ["Solo Friendly", "Family Friendly"], coordinates: [28.5933, 77.2197] },
            { id: 2, name: "Majnu ka Tilla (Tibetan Colony)", category: "cafe", rating: 4.6, reviews: 89, distance: "1.2km", image: "https://images.unsplash.com/photo-1507133750050-6b6c0734a9b9?q=80&w=400&auto=format&fit=crop", alt: "Tibetan cultural enclave with authentic food stalls", description: "Lesser-known food paradise with Tibetan cafes & peaceful vibes.", hours: "Open till late night", safety: ["Group Friendly", "Foodie Spot"], coordinates: [28.7156, 77.2396] },
            { id: 3, name: "Champa Gali, Saket", category: "cafe", rating: 4.9, reviews: 156, distance: "1.5km", image: "https://images.unsplash.com/photo-1549488347-194120359f13?q=80&w=400&auto=format&fit=crop", alt: "Hidden alleyway with artistic cafes, fairy lights, and boutique shops", description: "Hidden alley with artsy cafes, fairy lights, and indie shops.", hours: "11 AM - 11 PM", safety: ["Romantic Spot", "Instagram Worthy"], coordinates: [28.5207, 77.2046] },
            { id: 4, name: "Ridge Road, Civil Lines", category: "park", rating: 4.4, reviews: 67, distance: "0.5km", image: "https://images.unsplash.com/photo-1490656037041-3d750011559c?q=80&w=400&auto=format&fit=crop", alt: "Scenic road through forested area perfect for cycling", description: "A peaceful, lesser-known stretch for night walks & cycling.", hours: "24 hours", safety: ["Solo Friendly", "Well Lit"], coordinates: [28.6863, 77.2286] },
            { id: 5, name: "Hauz Khas Village Rooftops", category: "nightlife", rating: 4.7, reviews: 92, distance: "0.3km", image: "https://images.unsplash.com/photo-1521747116042-5a810ad7c201?q=80&w=400&auto=format&fit=crop", alt: "Trendy rooftop bars with panoramic views", description: "Rooftop bars with stunning city views and great atmosphere.", hours: "5:00 PM - 2:00 AM", safety: ["Group Friendly", "Romantic Spot"], coordinates: [28.5545, 77.1947] },
            { id: 6, name: "Sunder Nursery Heritage Park", category: "historical", rating: 4.5, reviews: 78, distance: "1.8km", image: "https://images.unsplash.com/photo-1557088463-c715104675e2?q=80&w=400&auto=format&fit=crop", alt: "Restored Mughal-era gardens", description: "Beautifully restored heritage park with Mughal-era monuments.", hours: "7:00 AM - 7:00 PM", safety: ["Family Friendly", "Solo Friendly"], coordinates: [28.5937, 77.2431] }
        ];
        let map;
        let markers = [];
        let userLocation = null;
        let userMarker = null;
        let exploreInitialized = false;

        function initExploreApp() {
            if (exploreInitialized) {
                setTimeout(() => { if(map) map.invalidateSize() }, 100);
                return;
            };
            initMap();
            renderPlaces('all');
            setupExploreEventListeners();
            exploreInitialized = true;
        }

        function initMap() {
            if (document.getElementById('map') && !map) {
                map = L.map('map').setView([28.6139, 77.2090], 12); // Default to Delhi coordinates
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19,
                }).addTo(map);
                updateMapMarkers('all');
            }
        }

        function updateMapMarkers(category) {
            if(!map) return;
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            let filteredPlaces = places.filter(place => category === 'all' || place.category === category);
            filteredPlaces.forEach(place => {
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${place.category === 'cafe' ? '#f59e0b' : place.category === 'park' ? '#10b981' : place.category === 'historical' ? '#2563eb' : '#f97316'}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"><i class="fas fa-${place.category === 'cafe' ? 'coffee' : place.category === 'park' ? 'tree' : place.category === 'historical' ? 'landmark' : 'star'}"></i></div>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42],
                    popupAnchor: [0, -42]
                });
                const marker = L.marker(place.coordinates, { icon: customIcon }).addTo(map)
                    .bindPopup(`<div class='popup-title'>${place.name}</div><div class='popup-desc'>${place.description}</div><div class='popup-time'>Rating: ${generateStars(place.rating)}</div>`);
                markers.push(marker);
            });
        }
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setView([userLocation.lat, userLocation.lng], 14);
                        
                        if (userMarker) map.removeLayer(userMarker);
                        const userIcon = L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background-color: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup("You are here!").openPopup();
                        L.circle([userLocation.lat, userLocation.lng], { color: 'blue', fillColor: '#3388ff', fillOpacity: 0.2, radius: 200 }).addTo(map);
                        
                        updateDistances();
                        const currentCategory = document.querySelector('.category-filter.active').getAttribute('data-category');
                        renderPlaces(currentCategory);
                        showNotification('Location found! Showing nearby places.', 'success');
                    },
                    error => {
                        showNotification('Unable to get your location. Please enable permissions.', 'error');
                    }
                );
            } else {
                showNotification('Geolocation is not supported by this browser.', 'error');
            }
        }

        function updateDistances() {
            if (!userLocation) return;
            places.forEach(place => {
                const distance = calculateDistance(userLocation.lat, userLocation.lng, place.coordinates[0], place.coordinates[1]);
                place.distance = `${distance.toFixed(1)}km`;
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of earth in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function renderPlaces(category) {
            const grid = document.getElementById('places-grid');
            if(!grid) return;
            grid.innerHTML = '';
            let filteredPlaces = places.filter(place => category === 'all' || place.category === category);
            if (userLocation) {
                filteredPlaces.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            }
            filteredPlaces.forEach(place => {
                const card = createPlaceCard(place);
                grid.appendChild(card);
            });
        }

        function createPlaceCard(place) {
            const card = document.createElement('div');
            // IMPROVEMENT: Dark card background applied via CSS variables
            card.className = 'place-card bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-[--primary-color]';
            card.innerHTML = `
                <div class="relative">
                    <img src="${place.image}" alt="${place.alt}" class="w-full h-48 object-cover">
                    <div class="absolute top-3 right-3 bg-[--card-dark] px-3 py-1 rounded-full shadow-md border border-[#4b5563]">
                        <span class="text-sm font-semibold text-[--text-light]">${place.distance}</span>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-lg text-gray-800">${place.name}</h4>
                        <span class="bg-orange-100 text-[--secondary-color] text-xs px-2 py-1 rounded-full font-medium">${place.category.charAt(0).toUpperCase() + place.category.slice(1)}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${place.description}</p>
                    <div class="flex items-center text-sm">
                        ${generateStars(place.rating)}
                        <span class="text-gray-500 ml-2">(${place.reviews})</span>
                    </div>
                </div>
            `;
            return card;
        }

        function setupExploreEventListeners() {
            document.querySelectorAll('.category-filter').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.getAttribute('data-category');
                    renderPlaces(category);
                    updateMapMarkers(category);
                });
            });
        }

        // Dummy data for Travel Buddies
        const buddies = [
            { id: 1, name: "Sarah J.", destination: "Paris, France", interests: ["foodie", "art"], bio: "Looking for someone to share pastries and museum lines with!", pic: "https://placehold.co/100x100/9f7aea/ffffff?text=S", available: "Dec 1 - Dec 10" },
            { id: 2, name: "Mike T.", destination: "Bali, Indonesia", interests: ["adventure", "beach"], bio: "Hoping to find a surf buddy for a 2-week trip.", pic: "https://placehold.co/100x100/4299e1/ffffff?text=M", available: "Jan 15 - Jan 30" },
            { id: 3, name: "Laura A.", destination: "Maldives", interests: ["relaxation", "luxury"], bio: "Looking to split a private bungalow and enjoy the sun.", pic: "https://placehold.co/100x100/ed8936/ffffff?text=L", available: "Feb 1 - Feb 7" },
            { id: 4, name: "David K.", destination: "Tokyo, Japan", interests: ["foodie", "art"], bio: "Into photography and street food. Let's explore the hidden alleys!", pic: "https://placehold.co/100x100/34d399/ffffff?text=D", available: "Anytime in Spring" },
            { id: 5, name: "Jessica R.", destination: "New York, USA", interests: ["art", "nightlife"], bio: "Need a partner for Broadway shows and rooftop bars.", pic: "https://placehold.co/100x100/f87171/ffffff?text=J", available: "Next Month" }
        ];

        // --- START OF BUDDIES AND MESSAGE SCRIPT ---
        const requestModal = document.getElementById('request-modal');
        const confirmRequestBtn = document.getElementById('confirm-request-btn');
        const cancelRequestBtn = document.getElementById('cancel-request-btn');
        let buddyToSendRequestTo = null; // To store the selected buddy's name

        function renderBuddies(buddiesList = buddies) {
            const grid = document.getElementById('buddies-grid');
            if (!grid) return;
            grid.innerHTML = '';
            buddiesList.forEach(buddy => {
                const card = createBuddyCard(buddy);
                grid.appendChild(card);
            });
            // Re-attach event listeners after rendering
            document.querySelectorAll('.connect-buddy-btn').forEach(btn => {
                btn.addEventListener('click', openRequestModal);
            });
        }

        function createBuddyCard(buddy) {
            const card = document.createElement('div');
            // IMPROVEMENT: Dark card background applied via CSS variables
            card.className = 'buddy-card bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4 transition-transform duration-300 hover:shadow-xl hover:scale-[1.01]';
            card.dataset.destination = buddy.destination;
            card.dataset.interests = buddy.interests.join(' ');
            card.dataset.buddyid = buddy.id; // Added buddy ID
            card.style.display = 'flex'; // Default to visible, filterBuddies handles hiding
            card.innerHTML = `
                <img src="${buddy.pic}" alt="${buddy.name}" class="w-16 h-16 rounded-full object-cover flex-shrink-0 shadow-md">
                <div class="flex-grow">
                    <h4 class="font-bold text-gray-800 text-lg">${buddy.name} <span class="text-xs font-normal bg-teal-100 text-teal-800 px-2 py-0.5 rounded-full ml-1">New</span></h4>
                    <p class="text-sm text-gray-500 mb-1"><i class="fas fa-map-marker-alt text-xs mr-1 text-red-400"></i> ${buddy.destination}</p>
                    <p class="text-sm text-gray-700 truncate">${buddy.bio}</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        ${buddy.interests.map(i => `<span class="bg-blue-50 text-[--primary-color] text-xs font-medium px-2 py-1 rounded-full">${i.charAt(0).toUpperCase() + i.slice(1)}</span>`).join('')}
                    </div>
                </div>
                <button class="connect-buddy-btn bg-[--primary-color] text-white font-semibold px-4 py-2 rounded-xl text-sm flex-shrink-0 hover:bg-[#1d4ed8] transition-colors shadow-md" data-buddy-name="${buddy.name}" data-buddy-pic="${buddy.pic}" data-destination="${buddy.destination}">
                    <i class="fas fa-handshake mr-1"></i> Connect
                </button>`;
            return card;
        }

        function openRequestModal(e) {
            buddyToSendRequestTo = {
                name: e.target.dataset.buddyName,
                pic: e.target.dataset.buddyPic,
                destination: e.target.dataset.destination
            };
            document.getElementById('buddy-request-name').textContent = buddyToSendRequestTo.name;
            const modalContent = document.getElementById('request-modal-content');
            requestModal.classList.remove('hidden', 'opacity-0');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => { 
                requestModal.classList.remove('opacity-0'); 
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeRequestModal() {
            const modalContent = document.getElementById('request-modal-content');
            requestModal.classList.add('opacity-0');
            modalContent.classList.add('opacity-0', 'scale-95');
            modalContent.classList.remove('scale-100');
            document.body.classList.remove('overflow-hidden');
            setTimeout(() => requestModal.classList.add('hidden'), 250);
            buddyToSendRequestTo = null;
        }

        confirmRequestBtn.addEventListener('click', () => {
            if (buddyToSendRequestTo) {
                // 1. Add the new conversation entry
                conversationData[buddyToSendRequestTo.name] = {
                    pic: buddyToSendRequestTo.pic,
                    messages: [
                        { sender: buddyToSendRequestTo.name, text: `Hello! Thanks for connecting. I'm excited about the possibility of a trip to ${buddyToSendRequestTo.destination}.` },
                        { sender: 'You', text: 'Me too! I was just checking out some of the local sights. When are you looking to go?' }
                    ]
                };

                // 2. Display success notification
                showNotification(`You are now connected with ${buddyToSendRequestTo.name}!`, 'success');

                // 3. Navigate to the Messages page
                closeRequestModal();
                showPage('page-messages');
                
                // 4. Highlight the new conversation
                renderConversationsList(); 
                
                // 5. Load the new conversation's chat window
                loadConversation(buddyToSendRequestTo.name); 

                // 6. Remove the buddy card to simulate connection completion
                // In a real app, you'd change the button state, but for this demo, we'll remove it.
                document.querySelector(`.buddy-card button[data-buddy-name="${buddyToSendRequestTo.name}"]`).closest('.buddy-card').remove();
            }
        });

        cancelRequestBtn.addEventListener('click', closeRequestModal);
        // --- END OF BUDDIES AND MESSAGE SCRIPT ---


        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = {};
            let currentImageUrl = '';
            let tripCounter = 0;
            const authPage = document.getElementById('page-auth');
            const mainApp = document.getElementById('main-app-content');
            const loginFormContainer = document.getElementById('login-form-container');
            const signupFormContainer = document.getElementById('signup-form-container');
            const showSignupLink = document.getElementById('show-signup-link');
            const showLoginLink = document.getElementById('show-login-link');
            const pages = document.querySelectorAll('.page');
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');

            const navMapping = {
                'nav-dashboard': 'page-dashboard',
                'nav-buddies': 'page-buddies',
                'nav-planner': 'page-planner',
                'nav-explore': 'page-explore',
                'nav-profile': 'page-profile',
            };
            
            const navElements = {
                'dashboard-messages-btn': 'page-messages',
                'dashboard-plan-card': 'page-planner',
                'dashboard-buddy-card': 'page-buddies',
                'dashboard-explore-card': 'page-explore',
            }

            function showPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                bottomNavItems.forEach(item => {
                    if (navMapping[item.id] === pageId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                if (pageId === 'page-messages') {
                    renderConversationsList();
                    // Load first conversation automatically on larger screens
                    if(window.innerWidth >= 768 && Object.keys(conversationData).length > 0) {
                        loadConversation(Object.keys(conversationData)[0]); 
                        document.getElementById('chat-window').classList.remove('hidden');
                        document.getElementById('chat-window').classList.add('flex');
                    } else {
                        document.getElementById('chat-window').classList.add('hidden');
                        document.getElementById('chat-window').classList.remove('flex');
                    }
                }
                if(pageId === 'page-explore') {
                    initExploreApp();
                }
                if(pageId === 'page-buddies') {
                    renderBuddies();
                }
            }
            
            // --- App Initialization ---
            Object.keys(navMapping).forEach(navId => {
                document.getElementById(navId).addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(navMapping[navId]);
                });
            });
            Object.keys(navElements).forEach(navId => {
                document.getElementById(navId)?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(navElements[navId]);
                });
            });


            // --- Authentication Toggle & Logic ---
            showSignupLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginFormContainer.classList.add('hidden');
                signupFormContainer.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                signupFormContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
            });
            
            function capitalize(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const name = email.split('@')[0];

                currentUser = {
                    name: capitalize(name),
                    bio: "Travel enthusiast and foodie exploring the world one city at a time. I believe the best way to experience a new place is through its culture, food, and people. Looking for buddies for my next adventure!",
                    travelStyles: ["Adventurous", "Foodie", "Cultural", "Budget Traveler"],
                    reviews: [],
                    trips: []
                };
                addDefaultReview(); // Add default review for demonstration
                updateProfileDisplay();
                authPage.classList.remove('active');
                mainApp.classList.remove('hidden');
                document.getElementById('nav-dashboard').classList.add('active');
                showPage('page-dashboard');
            });
            
            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                showNotification('Account created successfully! Please log in.', 'success');
                document.getElementById('email').value = document.getElementById('signup-email').value;
                showLoginLink.click();
            });

            // --- Logout ---
            document.getElementById('logout-link').addEventListener('click', (e) => {
                e.preventDefault();
                currentUser = {};
                
                const tripsGrid = document.getElementById('my-trips-grid');
                tripsGrid.innerHTML = `<div class="flex-shrink-0 w-64 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-center p-6 bg-white hover:bg-gray-50 transition-colors duration-300 cursor-pointer shadow-sm" onclick="document.getElementById('nav-planner').click()"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-[--primary-color] mb-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><h3 class="font-semibold text-gray-700">Plan a New Trip</h3></div>`;

                document.getElementById('login-form').reset();
                document.getElementById('signup-form').reset();

                mainApp.classList.add('hidden');
                authPage.classList.add('active');
                showPage('page-auth');
                showNotification("You've been logged out.", "success");
            });

            // --- AI Itinerary Planner Logic ---
            const plannerForm = document.getElementById('planner-form');
            const plannerLoading = document.getElementById('planner-loading');
            const plannerResults = document.getElementById('planner-results');
            const itineraryContent = document.getElementById('itinerary-content');
            const saveItineraryBtn = document.getElementById('save-itinerary-btn');
            const regenerateBtn = document.getElementById('regenerate-itinerary-btn');
            const itineraryHeader = document.getElementById('itinerary-header');

            document.querySelectorAll('.interest-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.classList.toggle('active'));
            });
            
            plannerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const destination = document.getElementById('destination').value;
                const duration = document.getElementById('duration').value;
                const travelDate = document.getElementById('travel-date').value;
                const selectedInterests = Array.from(document.querySelectorAll('.interest-btn.active')).map(btn => btn.dataset.interest);

                plannerForm.classList.add('hidden');
                plannerLoading.classList.remove('hidden');
                plannerResults.classList.add('hidden');
                
                // MOCKUP FUNCTIONALITY (Simulate API Call)
                setTimeout(() => {
                    // Update Header and Image
                    currentImageUrl = `https://source.unsplash.com/1600x900/?${encodeURIComponent(destination)},travel`;
                    itineraryHeader.style.backgroundImage = `url('${currentImageUrl}')`;
                    document.getElementById('itinerary-title').textContent = `Trip to ${destination}`;
                    document.getElementById('itinerary-dates').textContent = travelDate ? `Starting: ${new Date(travelDate).toLocaleDateString()}` : `${duration} Days`;
                    
                    // Generate and render itinerary
                    itineraryContent.innerHTML = generateMockItineraryHTML(destination, duration, selectedInterests, travelDate);

                    plannerLoading.classList.add('hidden');
                    plannerResults.classList.remove('hidden');
                    
                    showNotification('Itinerary generated successfully!', 'success');
                }, 1500);
            });

            regenerateBtn.addEventListener('click', () => {
                plannerResults.classList.add('hidden');
                plannerForm.classList.remove('hidden');
                itineraryContent.innerHTML = '';
            });

            saveItineraryBtn.addEventListener('click', () => {
                const destination = document.getElementById('destination').value;
                const duration = document.getElementById('duration').value;
                const travelDate = document.getElementById('travel-date').value;
                
                // Calculate dummy end date for dashboard card
                const endDate = new Date(travelDate || Date.now());
                endDate.setDate(endDate.getDate() + parseInt(duration || 1));
                
                const tripData = { 
                    destination, 
                    imageUrl: currentImageUrl,
                    itineraryHTML: itineraryContent.innerHTML,
                    expenses: [{ desc: "Initial Booking", amount: 10000 }],
                    budget: 50000, 
                    startDate: new Date(travelDate).toLocaleDateString() || new Date().toLocaleDateString(),
                    endDate: endDate.toLocaleDateString()
                };
                addTripToDashboard(tripData);
                showNotification(`${destination} trip saved!`, 'success');
                showPage('page-dashboard');
                regenerateBtn.click(); // Reset the planner form
            });

            // --- Dynamic "My Trips" ---
            function addTripToDashboard(trip) {
                tripCounter++;
                const tripId = `trip-${tripCounter}`;
                trip.id = tripId;
                currentUser.trips.push(trip);

                const tripsGrid = document.getElementById('my-trips-grid');
                const newTripCard = document.createElement('div');
                newTripCard.id = tripId;
                // IMPROVEMENT: Dark card background applied via CSS variables
                newTripCard.className = "trip-card bg-white rounded-xl shadow-lg overflow-hidden flex-shrink-0 w-64";
                
                const imageUrl = trip.imageUrl || 'https://images.unsplash.com/photo-1473625247510-8ceb1760943f?q=80&w=2011&auto=format&fit=crop';

                newTripCard.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" alt="Trip to ${trip.destination}" class="w-full h-32 object-cover">
                        <div class="absolute inset-0 bg-black/30"></div>
                        <span class="absolute top-2 left-2 bg-[--primary-color] text-white text-xs font-bold px-3 py-1 rounded-full">${trip.startDate}</span>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold mb-2 text-gray-800">${trip.destination}</h3>
                        <p class="text-xs text-gray-500 mb-4">Ends: ${trip.endDate}</p>
                        <div class="flex gap-2">
                            <button class="view-trip-btn w-full text-sm bg-blue-100 text-[--primary-color] font-semibold py-2 rounded-xl hover:bg-blue-200 transition-colors" data-trip-id="${tripId}">View Plan</button>
                            <button class="complete-trip-btn w-full text-sm bg-orange-100 text-[--secondary-color] font-semibold py-2 rounded-xl hover:bg-orange-200 transition-colors" data-trip-id="${tripId}" data-destination="${trip.destination}">Complete</button>
                        </div>
                    </div>`;
                
                // Find the "Plan a New Trip" placeholder and insert before it.
                const newTripPlaceholder = tripsGrid.querySelector('.border-dashed');
                if (newTripPlaceholder) {
                    tripsGrid.insertBefore(newTripCard, newTripPlaceholder);
                } else {
                    tripsGrid.appendChild(newTripCard);
                }
            }
            
            // --- Buddy Filtering ---
            const buddyDestInput = document.getElementById('buddy-dest');
            const buddyInterestSelect = document.getElementById('buddy-interest');

            function filterBuddies() {
                const destinationQuery = buddyDestInput.value.toLowerCase();
                const interestQuery = buddyInterestSelect.value;
                
                const filteredList = buddies.filter(buddy => {
                    const destMatch = buddy.destination.toLowerCase().includes(destinationQuery) || destinationQuery === '';
                    const interestMatch = buddy.interests.includes(interestQuery) || interestQuery === 'any';
                    return destMatch && interestMatch;
                });
                
                renderBuddies(filteredList);
            }
            
            if(buddyDestInput) {
                buddyDestInput.addEventListener('input', filterBuddies);
                buddyInterestSelect.addEventListener('change', filterBuddies);
                renderBuddies();
            }

            // --- Profile Page Logic (Profile, Reviews, Modals) ---
            const profileModal = document.getElementById('edit-profile-modal');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
            const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const profilePicUpload = document.getElementById('profile-pic-upload');

            function openProfileModal() {
                document.getElementById('modal-profile-name').value = currentUser.name;
                document.getElementById('modal-profile-bio').value = currentUser.bio;
                populateTravelStyleModal();
                openInfoModal(profileModal);
            }
            
            editProfileBtn.addEventListener('click', openProfileModal);
            closeProfileModalBtn.addEventListener('click', () => closeInfoModal(profileModal));
            cancelProfileEditBtn.addEventListener('click', () => closeInfoModal(profileModal));
            
            profilePicUpload.addEventListener('change', (e) => {
                if(e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('profile-picture').src = event.target.result;
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            const allTravelStyles = ["Adventurous", "Foodie", "Cultural", "Budget Traveler", "Luxury", "Relaxation", "Nightlife", "History Buff"];
            // IMPROVEMENT: Dark mode-compatible accent colors for tags
            const travelStyleColors = {
                "Adventurous": "bg-teal-700 text-teal-100", "Foodie": "bg-amber-700 text-amber-100", "Cultural": "bg-sky-700 text-sky-100",
                "Budget Traveler": "bg-rose-700 text-rose-100", "Luxury": "bg-purple-700 text-purple-100", "Relaxation": "bg-green-700 text-green-100",
                "Nightlife": "bg-[--primary-color] text-white", "History Buff": "bg-yellow-700 text-yellow-100" 
            };

            function populateTravelStyleModal() {
                const container = document.getElementById('modal-travel-styles');
                container.innerHTML = '';
                allTravelStyles.forEach(style => {
                    const isSelected = currentUser.travelStyles.includes(style);
                    const tag = document.createElement('button');
                    tag.type = 'button';
                    tag.textContent = style;
                    tag.dataset.style = style;
                    
                    // Logic for applying dark mode styles
                    const selectedClasses = travelStyleColors[style] || 'bg-gray-700 text-gray-100';
                    const unselectedClasses = 'bg-gray-700 text-gray-100 border-gray-600 hover:bg-gray-600';
                    const borderClasses = isSelected ? `border-2 border-[--primary-color]` : `border border-gray-600`;

                    tag.className = `travel-style-tag px-3 py-1.5 rounded-full text-sm font-medium ${isSelected ? selectedClasses : unselectedClasses} ${borderClasses}`;
                    
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('selected');
                        // Update classes based on selection state
                        const isNowSelected = tag.classList.contains('selected');
                        const newClasses = isNowSelected ? selectedClasses : unselectedClasses;
                        const newBorder = isNowSelected ? `border-2 border-[--primary-color]` : `border border-gray-600`;
                        
                        tag.className = `travel-style-tag px-3 py-1.5 rounded-full text-sm font-medium ${newClasses} ${newBorder}`;
                    });
                    container.appendChild(tag);
                });
            }

            profileEditForm.addEventListener('submit', (e) => {
                e.preventDefault();
                currentUser.name = document.getElementById('modal-profile-name').value;
                currentUser.bio = document.getElementById('modal-profile-bio').value;

                const selectedStyles = [];
                document.querySelectorAll('#modal-travel-styles .travel-style-tag.selected').forEach(tag => {
                    selectedStyles.push(tag.dataset.style);
                });
                currentUser.travelStyles = selectedStyles;

                updateProfileDisplay();
                closeInfoModal(profileModal);
                showNotification('Profile updated successfully!', 'success');
            });

            function updateProfileDisplay() {
                document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.name}!`;
                document.getElementById('dashboard-avatar').textContent = currentUser.name.charAt(0);
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-bio-text').textContent = currentUser.bio;
                document.getElementById('profile-picture').src = document.getElementById('profile-picture').src.includes('placehold.co') ? `https://placehold.co/160x160/2563eb/ffffff?text=${currentUser.name.charAt(0)}` : document.getElementById('profile-picture').src;
                document.getElementById('profile-picture').alt = currentUser.name;

                const stylesContainer = document.getElementById('profile-travel-styles');
                stylesContainer.innerHTML = '';
                if(currentUser.travelStyles) {
                    currentUser.travelStyles.forEach(style => {
                        const tag = document.createElement('span');
                        tag.textContent = style;
                        // Use dark mode friendly colors for display
                        const colors = travelStyleColors[style] || 'bg-gray-700 text-gray-100';
                        tag.className = `${colors} text-sm font-medium px-3 py-1.5 rounded-full`;
                        stylesContainer.appendChild(tag);
                    });
                }
                renderReviews();
            }

            // --- Messages Feature ---
            const conversationData = {
                'Sarah J.': {
                    pic: 'https://placehold.co/100x100/9f7aea/ffffff?text=S',
                    messages: [
                        { sender: 'Sarah J.', text: 'Hey! Are you excited for our Paris trip?' },
                        { sender: 'You', text: 'Absolutely! I was just looking at some cafes in Le Marais.' },
                        { sender: 'Sarah J.', text: 'Oh nice! We should definitely check them out.' }
                    ]
                },
                'Mike T.': {
                    pic: 'https://placehold.co/100x100/4299e1/ffffff?text=M',
                    messages: [
                        { sender: 'Mike T.', text: 'Have you booked your flight to Bali yet?' },
                    ]
                },
                'Laura A.': {
                    pic: 'https://placehold.co/100x100/ed8936/ffffff?text=L',
                    messages: [
                        { sender: 'Laura A.', text: 'I found a great resort in the Maldives. Thoughts?' },
                        { sender: 'You', text: 'Sounds amazing! Send me the link.' },
                    ]
                }
            };
            
            function renderConversationsList() {
                const listEl = document.getElementById('conversations-list');
                listEl.innerHTML = '';
                Object.keys(conversationData).forEach(name => {
                    const data = conversationData[name];
                    const lastMessage = data.messages[data.messages.length - 1];
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'conversation-item flex items-center p-4 hover:bg-gray-100 transition-colors duration-200 border-b border-gray-100';
                    item.dataset.buddy = name;
                    item.innerHTML = `
                        <img src="${data.pic}" alt="${name}" class="w-12 h-12 rounded-full mr-4 shadow-sm">
                        <div class="flex-grow overflow-hidden">
                            <p class="font-semibold text-gray-800">${name}</p>
                            <p class="text-sm text-gray-500 truncate">${lastMessage.sender === 'You' ? 'You: ' : ''}${lastMessage.text}</p>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
                
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.target.closest('.conversation-item');
                        if (target) {
                            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
                            target.classList.add('active');
                            loadConversation(target.dataset.buddy);
                            if(window.innerWidth < 768) {
                                document.getElementById('conversations-list').classList.add('hidden');
                                document.getElementById('chat-window').classList.remove('hidden');
                                document.getElementById('chat-window').classList.add('flex', 'w-full');
                            }
                        }
                    });
                });
                if (listEl.querySelector('.conversation-item')) {
                    listEl.querySelector('.conversation-item').classList.add('active');
                }
            }

            function loadConversation(buddyName) {
                const data = conversationData[buddyName];
                const chatWindow = document.getElementById('chat-window');
                chatWindow.classList.remove('hidden'); 
                chatWindow.classList.add('flex', 'flex-col');
                
                chatWindow.innerHTML = `
                    <div class="p-4 border-b border-gray-200 flex items-center flex-shrink-0 bg-white">
                        <button class="md:hidden mr-4 text-gray-600 hover:text-[--primary-color] transition-colors" id="back-to-conversations"><i class="fas fa-arrow-left"></i></button>
                        <img src="${data.pic}" alt="${buddyName}" class="w-10 h-10 rounded-full mr-3 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-800">${buddyName}</h3>
                    </div>
                    <div id="chat-messages" class="flex-grow p-6 overflow-y-auto space-y-4 bg-gray-50">
                        ${data.messages.map(msg => `
                            <div class="flex ${msg.sender === 'You' ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow-md ${msg.sender === 'You' ? 'bg-[--primary-color] text-white rounded-br-none' : 'bg-white text-gray-800 rounded-tl-none'}">
                                    <p>${msg.text}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="p-4 bg-white border-t border-gray-200 flex-shrink-0">
                        <form id="message-form" class="flex items-center space-x-3">
                            <input type="text" id="message-input" placeholder="Type a message..." class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[--primary-color]" autocomplete="off">
                            <button type="submit" class="bg-[--primary-color] text-white rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0 hover:bg-[#1d4ed8] transition-colors shadow-md">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>`;

                const chatMessages = document.getElementById('chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const backBtn = document.getElementById('back-to-conversations');
                if(backBtn) {
                    backBtn.addEventListener('click', () => {
                        document.getElementById('conversations-list').classList.remove('hidden');
                        document.getElementById('chat-window').classList.add('hidden');
                        document.getElementById('chat-window').classList.remove('w-full');
                        document.getElementById('chat-window').classList.remove('flex');
                    });
                }

                document.getElementById('message-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('message-input');
                    const text = input.value.trim();
                    if (text) {
                        const newMessage = { sender: 'You', text };
                        data.messages.push(newMessage);
                        
                        const msgBubble = document.createElement('div');
                        msgBubble.className = 'flex justify-end';
                        msgBubble.innerHTML = `<div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow-md bg-[--primary-color] text-white rounded-br-none"><p>${text}</p></div>`;
                        chatMessages.appendChild(msgBubble);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        input.value = '';
                        renderConversationsList();
                        document.querySelector(`.conversation-item[data-buddy="${buddyName}"]`).classList.add('active');


                        setTimeout(() => {
                            const reply = { sender: buddyName, text: 'Sounds good!' };
                            data.messages.push(reply);
                            const replyBubble = document.createElement('div');
                            replyBubble.className = 'flex justify-start';
                            replyBubble.innerHTML = `<div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow-md bg-white text-gray-800 rounded-tl-none"><p>${reply.text}</p></div>`;
                            chatMessages.appendChild(replyBubble);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            renderConversationsList();
                            document.querySelector(`.conversation-item[data-buddy="${buddyName}"]`).classList.add('active');
                        }, 1500);
                    }
                });
            }

            // --- Review & Rating Logic ---
            const reviewModal = document.getElementById('review-modal');
            const reviewForm = document.getElementById('review-form');
            const tripsGrid = document.getElementById('my-trips-grid');
            let currentTripToReview = null;

            tripsGrid.addEventListener('click', (e) => {
                const completeButton = e.target.closest('.complete-trip-btn');
                const viewButton = e.target.closest('.view-trip-btn');
                
                if (completeButton) {
                    const tripId = completeButton.dataset.tripId;
                    const tripData = currentUser.trips.find(t => t.id === tripId);

                    currentTripToReview = {
                        id: tripId,
                        destination: completeButton.dataset.destination
                    };
                    document.getElementById('review-destination').textContent = currentTripToReview.destination;
                    openInfoModal(reviewModal);
                } else if (viewButton) {
                    const tripId = viewButton.dataset.tripId;
                    const tripData = currentUser.trips.find(t => t.id === tripId);
                    if(tripData) {
                        openViewTripModal(tripData);
                    }
                }
            });

            document.getElementById('cancel-review-btn').addEventListener('click', () => {
                closeInfoModal(reviewModal);
            });
            
            const reviewStars = document.getElementById('review-stars');
            reviewStars.addEventListener('click', (e) => {
                if(e.target.tagName === 'I') {
                    const rating = e.target.dataset.rating;
                    document.getElementById('review-rating-value').value = rating;
                    
                    reviewStars.querySelectorAll('i').forEach(star => {
                        star.classList.remove('active', 'text-yellow-400', 'fas');
                        star.classList.add('far', 'text-gray-300');
                    });
                    
                    for(let i=1; i <= rating; i++) {
                        reviewStars.querySelector(`[data-rating="${i}"]`).classList.add('active', 'text-yellow-400', 'fas');
                        reviewStars.querySelector(`[data-rating="${i}"]`).classList.remove('far', 'text-gray-300');
                    }
                }
            });

            reviewForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newReview = {
                    from: currentTripToReview.destination, 
                    pic: "https://placehold.co/40x40/fbbf24/ffffff?text=T",
                    rating: document.getElementById('review-rating-value').value,
                    text: document.getElementById('review-text').value
                };
                
                currentUser.reviews.unshift(newReview);
                updateProfileDisplay();

                document.getElementById(currentTripToReview.id)?.remove();
                
                closeInfoModal(reviewModal);
                reviewForm.reset();
                reviewStars.querySelectorAll('i').forEach(star => {
                    star.classList.remove('active', 'text-yellow-400', 'fas');
                    star.classList.add('far', 'text-gray-300');
                });
                
                showNotification('Review submitted!', 'success');
            });
            
            function addDefaultReview() {
                if (!currentUser.reviews) currentUser.reviews = [];
                currentUser.reviews.push({
                    from: 'Sarah J.',
                    pic: 'https://placehold.co/40x40/9f7aea/ffffff?text=S',
                    rating: 5,
                    text: `"${currentUser.name} was an amazing travel buddy in Paris! So knowledgeable and fun."`
                });
            }
            
            function renderReviews() {
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = '';
                if(currentUser.reviews && currentUser.reviews.length > 0) {
                    currentUser.reviews.forEach(review => {
                        const reviewEl = document.createElement('div');
                        // IMPROVEMENT: Dark card background/border
                        reviewEl.className = 'bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500';
                        reviewEl.innerHTML = `
                            <div class="flex items-start mb-2">
                                <img src="${review.pic}" alt="${review.from}" class="w-10 h-10 rounded-full mr-3 flex-shrink-0">
                                <div>
                                    <p class="font-semibold text-gray-800">Review: ${review.from}</p>
                                    ${generateStars(review.rating)}
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm italic">"${review.text.replace(/"/g, '')}"</p>`;
                        reviewsList.appendChild(reviewEl);
                    });
                } else {
                    // IMPROVEMENT: Dark card background
                    reviewsList.innerHTML = `<p class="text-gray-500 text-sm text-center bg-white p-6 rounded-xl shadow-md">No reviews yet. Complete a trip to get your first review!</p>`;
                }
            }


            // --- Profile Info Modals & Trip View Modal ---
            const aboutModal = document.getElementById('about-modal');
            const contactModal = document.getElementById('contact-modal');
            const helpModal = document.getElementById('help-modal');
            const viewTripModal = document.getElementById('view-trip-modal');

            document.getElementById('about-us-link').addEventListener('click', (e) => { e.preventDefault(); openInfoModal(aboutModal); });
            document.getElementById('contact-support-link').addEventListener('click', (e) => { e.preventDefault(); openInfoModal(contactModal); });
            document.getElementById('help-center-link').addEventListener('click', (e) => { e.preventDefault(); openInfoModal(helpModal); });

            document.querySelectorAll('.close-info-modal-btn, #close-view-trip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeInfoModal(btn.closest('.modal'));
                });
            });

            function openViewTripModal(tripData) {
                document.getElementById('view-trip-title').textContent = `Trip to ${tripData.destination}`;
                document.getElementById('view-trip-header').style.backgroundImage = `url('${tripData.imageUrl}')`;
                document.getElementById('view-trip-itinerary').innerHTML = tripData.itineraryHTML;
                
                // Budget tracker logic
                const expenseForm = document.getElementById('expense-form');
                const expenseList = document.getElementById('expense-list');
                const budgetSpentEl = document.getElementById('budget-spent');
                const budgetTotalEl = document.getElementById('budget-total');
                const budgetProgress = document.getElementById('budget-progress');

                budgetTotalEl.textContent = `₹${tripData.budget.toLocaleString()}`;
                
                function updateBudget() {
                    const totalSpent = tripData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
                    budgetSpentEl.textContent = `₹${totalSpent.toLocaleString()}`;
                    const percentage = Math.min((totalSpent / tripData.budget) * 100, 100);
                    budgetProgress.style.width = `${percentage}%`;
                    budgetProgress.style.backgroundColor = percentage > 80 ? '#ef4444' : '#22c55e';
                    budgetSpentEl.classList.toggle('text-red-600', percentage > 80);
                    budgetSpentEl.classList.toggle('text-green-600', percentage <= 80);
                }

                function renderExpenses() {
                    expenseList.innerHTML = '';
                    tripData.expenses.forEach(expense => {
                        const li = document.createElement('li');
                        // IMPROVEMENT: Dark background list items
                        li.className = 'flex justify-between items-center text-sm py-1';
                        li.innerHTML = `<span class="text-gray-700">${expense.desc}</span><span class="font-semibold text-gray-800">₹${expense.amount.toLocaleString()}</span>`;
                        expenseList.appendChild(li);
                    });
                }
                
                const onExpenseSubmit = (e) => {
                    e.preventDefault();
                    const descInput = document.getElementById('expense-desc');
                    const amountInput = document.getElementById('expense-amount');
                    const amount = parseFloat(amountInput.value);

                    if(descInput.value.trim() && amount > 0) {
                        tripData.expenses.push({ desc: descInput.value, amount: amount });
                        renderExpenses();
                        updateBudget();
                        descInput.value = '';
                        amountInput.value = '';
                        showNotification('Expense added!', 'success');
                    } else {
                        showNotification('Invalid expense details.', 'error');
                    }
                };

                // Remove existing listener before adding a new one (to prevent duplicates)
                expenseForm.removeEventListener('submit', expenseForm.currentListener);
                expenseForm.currentListener = onExpenseSubmit;
                expenseForm.addEventListener('submit', onExpenseSubmit);

                renderExpenses();
                updateBudget();
                openInfoModal(viewTripModal);
            }
            
            // Initial Load - Ensure correct starting page and nav state
            showPage('page-auth');
        });
    </script>
</body>
</html>
